7ccb285b600bd560c070a56039d90917
"use strict";
/**
 * Guard d'authentification JWT pour le Service de Gestion des Projets (C04)
 *
 * Ce guard assure la validation des tokens JWT pour toutes les routes protégées,
 * intègre un cache Redis pour optimiser les performances, et maintient un audit
 * trail complet des tentatives d'accès.
 *
 * Responsabilités :
 * - Validation des tokens JWT via le Service d'Authentification (C03)
 * - Cache intelligent des validations pour améliorer les performances
 * - Injection des informations utilisateur dans le contexte de requête
 * - Audit de sécurité et logging structuré
 * - Gestion gracieuse des erreurs et timeouts
 *
 * @fileoverview Guard principal d'authentification JWT
 * @version 1.0.0
 * @since 2025-01-28
 */
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AuthGuard_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthGuard = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const axios_1 = require("@nestjs/axios");
const crypto_1 = require("crypto");
const rxjs_1 = require("rxjs");
const user_interface_1 = require("../interfaces/user.interface");
const cache_service_1 = require("../../cache/cache.service");
/**
 * Configuration par défaut du guard
 */
const DEFAULT_CONFIG = {
    cachePrefix: 'auth:token:',
    cacheTTL: 300, // 5 minutes
    validationTimeout: 5000, // 5 secondes
    retryAttempts: 3,
    retryDelay: 1000, // 1 seconde
    logLevel: 'info',
};
/**
 * Guard d'authentification JWT
 *
 * Implémente la validation sécurisée des tokens JWT avec cache Redis
 * pour optimiser les performances et audit complet des accès.
 */
let AuthGuard = AuthGuard_1 = class AuthGuard {
    configService;
    cacheService;
    httpService;
    logger = new common_1.Logger(AuthGuard_1.name);
    AUTH_SERVICE_URL;
    CACHE_TTL;
    VALIDATION_TIMEOUT;
    constructor(configService, cacheService, httpService) {
        this.configService = configService;
        this.cacheService = cacheService;
        this.httpService = httpService;
        // Récupération de la configuration avec fallback direct sur les variables d'environnement
        this.AUTH_SERVICE_URL = this.configService.get('AUTH_SERVICE_URL') ||
            process.env.AUTH_SERVICE_URL ||
            'http://localhost:3001';
        this.VALIDATION_TIMEOUT = parseInt(this.configService.get('AUTH_SERVICE_TIMEOUT') ||
            process.env.AUTH_SERVICE_TIMEOUT ||
            '5000', 10);
        this.CACHE_TTL = parseInt(this.configService.get('CACHE_TTL') ||
            process.env.CACHE_TTL ||
            DEFAULT_CONFIG.cacheTTL.toString(), 10);
        this.logger.log(`AuthGuard initialized with service URL: ${this.AUTH_SERVICE_URL}`);
    }
    /**
     * Point d'entrée principal du guard NestJS
     *
     * @param context - Contexte d'exécution de la requête
     * @returns Promise<boolean> - true si authentification réussie
     */
    async canActivate(context) {
        const startTime = Date.now();
        let user;
        let tokenHash = '';
        let cacheHit = false;
        try {
            // Extraction de la requête selon le contexte (HTTP, WebSocket, etc.)
            const request = this.getRequest(context);
            // Extraction du token JWT
            const token = this.extractTokenFromRequest(request);
            if (!token) {
                await this.auditAccessAttempt('', false, undefined, new Error('Token missing'), false, Date.now() - startTime);
                throw new common_1.UnauthorizedException('Authentication token is required');
            }
            // Génération du hash pour le cache et l'audit
            tokenHash = this.hashToken(token);
            // Vérification du cache
            user = await this.getCachedValidation(token);
            if (user) {
                cacheHit = true;
                this.logger.debug(`Cache hit for token ${tokenHash.substring(0, 8)}...`);
            }
            else {
                // Validation via le service d'authentification
                user = await this.validateTokenWithAuthService(token);
                // Mise en cache de la validation réussie
                await this.cacheValidation(token, user, new Date(Date.now() + this.CACHE_TTL * 1000));
                this.logger.debug(`Token validated and cached for ${user.email}`);
            }
            // Injection de l'utilisateur dans le contexte
            this.injectUserIntoContext(context, user);
            // Audit de la tentative réussie
            await this.auditAccessAttempt(tokenHash, true, user, undefined, cacheHit, Date.now() - startTime);
            return true;
        }
        catch (error) {
            // Audit de la tentative échouée
            await this.auditAccessAttempt(tokenHash, false, user, error, cacheHit, Date.now() - startTime);
            // Gestion des erreurs
            this.handleAuthError(error, 'canActivate');
            return false;
        }
    }
    /**
     * Extraction de l'objet request selon le type de contexte
     *
     * @param context - Contexte d'exécution
     * @returns L'objet request
     */
    getRequest(context) {
        const contextType = context.getType();
        switch (contextType) {
            case 'http':
                return context.switchToHttp().getRequest();
            case 'ws':
                // Support WebSocket si nécessaire dans le futur
                return context.switchToWs().getClient().handshake;
            default:
                throw new common_1.InternalServerErrorException('Unsupported context type');
        }
    }
    /**
     * Extraction du token JWT depuis les headers de requête
     *
     * @param request - Requête Fastify
     * @returns Token JWT ou null si absent/invalide
     */
    extractTokenFromRequest(request) {
        try {
            const authHeader = request.headers.authorization;
            if (!authHeader) {
                return null;
            }
            // Vérification du format "Bearer <token>"
            const parts = authHeader.split(' ');
            if (parts.length !== 2 || parts[0] !== 'Bearer') {
                this.logger.warn('Invalid authorization header format');
                return null;
            }
            const token = parts[1];
            // Validation basique du token (non vide, longueur minimale)
            if (!token || token.length < 10) {
                this.logger.warn('Token too short or empty');
                return null;
            }
            return token;
        }
        catch (error) {
            this.logger.error('Error extracting token from request', error);
            return null;
        }
    }
    /**
     * Recherche d'une validation en cache
     *
     * @param token - Token JWT à vérifier
     * @returns Utilisateur si trouvé en cache, undefined sinon
     */
    async getCachedValidation(token) {
        try {
            const cacheKey = this.buildCacheKey(token);
            const cachedData = await this.cacheService.get(cacheKey);
            if (cachedData && (0, user_interface_1.isValidUser)(cachedData)) {
                return cachedData;
            }
            return undefined;
        }
        catch (error) {
            this.logger.warn('Cache retrieval failed, falling back to service validation', error);
            return undefined;
        }
    }
    /**
     * Validation du token via le Service d'Authentification (C03)
     *
     * @param token - Token JWT à valider
     * @returns Utilisateur validé
     */
    async validateTokenWithAuthService(token) {
        try {
            const validationUrl = `${this.AUTH_SERVICE_URL}/api/v1/auth/validate-token`;
            const response$ = this.httpService.post(validationUrl, { token }, {
                timeout: this.VALIDATION_TIMEOUT,
                headers: {
                    'Content-Type': 'application/json',
                    'User-Agent': 'project-service/1.0.0',
                },
            }).pipe((0, rxjs_1.timeout)(this.VALIDATION_TIMEOUT), (0, rxjs_1.catchError)((error) => {
                if (error.response?.status === 401) {
                    throw new common_1.UnauthorizedException('Invalid or expired token');
                }
                if (error.code === 'ECONNREFUSED' || error.code === 'ENOTFOUND') {
                    throw new common_1.ServiceUnavailableException('Authentication service unavailable');
                }
                throw new common_1.InternalServerErrorException('Authentication service error');
            }));
            const response = await (0, rxjs_1.firstValueFrom)(response$);
            const data = response.data;
            // Validation de la réponse
            if (!data.valid || !data.user) {
                throw new common_1.UnauthorizedException('Token validation failed');
            }
            // Construction de l'objet User
            const user = {
                id: data.user.id,
                email: data.user.email,
                roles: data.user.roles || [],
            };
            // Validation finale de l'objet User
            if (!(0, user_interface_1.isValidUser)(user)) {
                throw new common_1.InternalServerErrorException('Invalid user data received from auth service');
            }
            return user;
        }
        catch (error) {
            if (error instanceof common_1.UnauthorizedException ||
                error instanceof common_1.ServiceUnavailableException ||
                error instanceof common_1.InternalServerErrorException) {
                throw error;
            }
            this.logger.error('Unexpected error during token validation', error);
            throw new common_1.InternalServerErrorException('Authentication failed');
        }
    }
    /**
     * Mise en cache de la validation réussie
     *
     * @param token - Token JWT
     * @param user - Utilisateur validé
     * @param expiresAt - Date d'expiration du token
     */
    async cacheValidation(token, user, expiresAt) {
        try {
            const cacheKey = this.buildCacheKey(token);
            // Calcul du TTL intelligent basé sur l'expiration du token
            const timeUntilExpiry = Math.floor((expiresAt.getTime() - Date.now()) / 1000);
            const ttl = Math.min(this.CACHE_TTL, Math.max(timeUntilExpiry, 60)); // Min 1 minute
            await this.cacheService.set(cacheKey, user, ttl);
        }
        catch (error) {
            // Cache non critique - on log mais on ne bloque pas
            this.logger.warn('Failed to cache token validation', error);
        }
    }
    /**
     * Injection de l'utilisateur dans le contexte de requête
     *
     * @param context - Contexte d'exécution
     * @param user - Utilisateur à injecter
     */
    injectUserIntoContext(context, user) {
        try {
            const request = this.getRequest(context);
            // Injection pour utilisation par le décorateur @CurrentUser()
            request.user = user;
        }
        catch (error) {
            this.logger.error('Failed to inject user into context', error);
            throw new common_1.InternalServerErrorException('Context injection failed');
        }
    }
    /**
     * Audit des tentatives d'accès pour la sécurité et le monitoring
     *
     * @param tokenHash - Hash du token (pour la sécurité)
     * @param success - Succès ou échec de l'authentification
     * @param user - Utilisateur (si authentification réussie)
     * @param error - Erreur (si authentification échouée)
     * @param cacheHit - Indicateur de cache hit
     * @param duration - Durée de validation en ms
     */
    async auditAccessAttempt(tokenHash, success, user, error, cacheHit, duration) {
        try {
            const auditData = {
                event: 'auth_attempt',
                success,
                tokenHash: tokenHash.substring(0, 16), // Premiers 16 caractères pour l'audit
                timestamp: new Date().toISOString(),
                userId: user?.id,
                error: error?.message,
                cachehit: cacheHit,
                validationDuration: duration,
            };
            if (success) {
                this.logger.log(`✅ Authentication successful for user ${user?.email}`, auditData);
            }
            else {
                this.logger.warn(`❌ Authentication failed: ${error?.message}`, auditData);
            }
            // TODO: Optionnellement envoyer vers un service d'audit externe
            // await this.auditService.logSecurityEvent(auditData);
        }
        catch (auditError) {
            // L'audit ne doit jamais bloquer l'authentification
            this.logger.error('Audit logging failed', auditError);
        }
    }
    /**
     * Gestion centralisée des erreurs d'authentification
     *
     * @param error - Erreur à traiter
     * @param context - Contexte où l'erreur s'est produite
     */
    handleAuthError(error, context) {
        // Classification et transformation des erreurs
        if (error instanceof common_1.UnauthorizedException ||
            error instanceof common_1.ServiceUnavailableException ||
            error instanceof common_1.InternalServerErrorException) {
            throw error;
        }
        // Erreurs inattendues
        this.logger.error(`Unexpected authentication error in ${context}`, error);
        // Ne pas leak d'informations sensibles
        throw new common_1.UnauthorizedException('Authentication failed');
    }
    /**
     * Construction de la clé de cache sécurisée
     *
     * @param token - Token JWT
     * @returns Clé de cache hashée
     */
    buildCacheKey(token) {
        const hash = this.hashToken(token);
        return `${DEFAULT_CONFIG.cachePrefix}${hash}`;
    }
    /**
     * Génération d'un hash SHA-256 du token pour la sécurité
     *
     * @param token - Token à hasher
     * @returns Hash SHA-256 en hexadécimal
     */
    hashToken(token) {
        return (0, crypto_1.createHash)('sha256').update(token).digest('hex');
    }
};
exports.AuthGuard = AuthGuard;
exports.AuthGuard = AuthGuard = AuthGuard_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [config_1.ConfigService,
        cache_service_1.CacheService,
        axios_1.HttpService])
], AuthGuard);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL25pY29sYXNiZXJuYXJkL0Rlc2t0b3AvcHJvamVjdC1zZXJ2aWNlL3NyYy9jb21tb24vZ3VhcmRzL2F1dGguZ3VhcmQudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRzs7Ozs7Ozs7Ozs7OztBQUVILDJDQVF3QjtBQUN4QiwyQ0FBK0M7QUFDL0MseUNBQTRDO0FBRTVDLG1DQUFvQztBQUNwQywrQkFBMkQ7QUFHM0QsaUVBQWlFO0FBQ2pFLDZEQUF5RDtBQThCekQ7O0dBRUc7QUFDSCxNQUFNLGNBQWMsR0FBRztJQUNyQixXQUFXLEVBQUUsYUFBYTtJQUMxQixRQUFRLEVBQUUsR0FBRyxFQUFFLFlBQVk7SUFDM0IsaUJBQWlCLEVBQUUsSUFBSSxFQUFFLGFBQWE7SUFDdEMsYUFBYSxFQUFFLENBQUM7SUFDaEIsVUFBVSxFQUFFLElBQUksRUFBRSxZQUFZO0lBQzlCLFFBQVEsRUFBRSxNQUFNO0NBQ1IsQ0FBQztBQUVYOzs7OztHQUtHO0FBRUksSUFBTSxTQUFTLGlCQUFmLE1BQU0sU0FBUztJQU9EO0lBQ0E7SUFDQTtJQVJGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxXQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEMsZ0JBQWdCLENBQVM7SUFDekIsU0FBUyxDQUFTO0lBQ2xCLGtCQUFrQixDQUFTO0lBRTVDLFlBQ21CLGFBQTRCLEVBQzVCLFlBQTBCLEVBQzFCLFdBQXdCO1FBRnhCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBRXpDLDBGQUEwRjtRQUMxRixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQVMsa0JBQWtCLENBQUM7WUFDbkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0I7WUFDNUIsdUJBQXVCLENBQUM7UUFDL0MsSUFBSSxDQUFDLGtCQUFrQixHQUFHLFFBQVEsQ0FDaEMsSUFBSSxD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O1FBQ2pDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkMsT0FBTyxHQUFHLGNBQWMsQ0FBQyxXQUFXLEdBQUcsSUFBSSxFQUFFLENBQUM7SUFDaEQsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssU0FBUyxDQUFDLEtBQWE7UUFDN0IsT0FBTyxJQUFBLG1CQUFVLEVBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxRCxDQUFDO0NBQ0YsQ0FBQTtBQTVXWSw4QkFBUztvQkFBVCxTQUFTO0lBRHJCLElBQUEsbUJBQVUsR0FBRTtxQ0FRdUIsc0JBQWE7UUFDZCw0QkFBWTtRQUNiLG1CQUFXO0dBVGhDLFNBQVMsQ0E0V3JCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9uaWNvbGFzYmVybmFyZC9EZXNrdG9wL3Byb2plY3Qtc2VydmljZS9zcmMvY29tbW9uL2d1YXJkcy9hdXRoLmd1YXJkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR3VhcmQgZCdhdXRoZW50aWZpY2F0aW9uIEpXVCBwb3VyIGxlIFNlcnZpY2UgZGUgR2VzdGlvbiBkZXMgUHJvamV0cyAoQzA0KVxuICogXG4gKiBDZSBndWFyZCBhc3N1cmUgbGEgdmFsaWRhdGlvbiBkZXMgdG9rZW5zIEpXVCBwb3VyIHRvdXRlcyBsZXMgcm91dGVzIHByb3TDqWfDqWVzLFxuICogaW50w6hncmUgdW4gY2FjaGUgUmVkaXMgcG91ciBvcHRpbWlzZXIgbGVzIHBlcmZvcm1hbmNlcywgZXQgbWFpbnRpZW50IHVuIGF1ZGl0XG4gKiB0cmFpbCBjb21wbGV0IGRlcyB0ZW50YXRpdmVzIGQnYWNjw6hzLlxuICogXG4gKiBSZXNwb25zYWJpbGl0w6lzIDpcbiAqIC0gVmFsaWRhdGlvbiBkZXMgdG9rZW5zIEpXVCB2aWEgbGUgU2VydmljZSBkJ0F1dGhlbnRpZmljYXRpb24gKEMwMylcbiAqIC0gQ2FjaGUgaW50ZWxsaWdlbnQgZGVzIHZhbGlkYXRpb25zIHBvdXIgYW3DqWxpb3JlciBsZXMgcGVyZm9ybWFuY2VzXG4gKiAtIEluamVjdGlvbiBkZXMgaW5mb3JtYXRpb25zIHV0aWxpc2F0ZXVyIGRhbnMgbGUgY29udGV4dGUgZGUgcmVxdcOqdGVcbiAqIC0gQXVkaXQgZGUgc8OpY3VyaXTDqSBldCBsb2dnaW5nIHN0cnVjdHVyw6lcbiAqIC0gR2VzdGlvbiBncmFjaWV1c2UgZGVzIGVycmV1cnMgZXQgdGltZW91dHNcbiAqIFxuICogQGZpbGVvdmVydmlldyBHdWFyZCBwcmluY2lwYWwgZCdhdXRoZW50aWZpY2F0aW9uIEpXVFxuICogQHZlcnNpb24gMS4wLjBcbiAqIEBzaW5jZSAyMDI1LTAxLTI4XG4gKi9cblxuaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgQ2FuQWN0aXZhdGUsXG4gIEV4ZWN1dGlvbkNvbnRleHQsXG4gIFVuYXV0aG9yaXplZEV4Y2VwdGlvbixcbiAgU2VydmljZVVuYXZhaWxhYmxlRXhjZXB0aW9uLFxuICBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uLFxuICBMb2dnZXIsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBIdHRwU2VydmljZSB9IGZyb20gJ0BuZXN0anMvYXhpb3MnO1xuaW1wb3J0IHsgRmFzdGlmeVJlcXVlc3QgfSBmcm9tICdmYXN0aWZ5JztcbmltcG9ydCB7IGNyZWF0ZUhhc2ggfSBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IHsgZmlyc3RWYWx1ZUZyb20sIHRpbWVvdXQsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEF4aW9zRXJyb3IgfSBmcm9tICdheGlvcyc7XG5cbmltcG9ydCB7IFVzZXIsIGlzVmFsaWRVc2VyIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy91c2VyLmludGVyZmFjZSc7XG5pbXBvcnQgeyBDYWNoZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9jYWNoZS9jYWNoZS5zZXJ2aWNlJztcblxuLyoqXG4gKiBJbnRlcmZhY2UgcG91ciBsYSByw6lwb25zZSBkdSBzZXJ2aWNlIGQnYXV0aGVudGlmaWNhdGlvblxuICovXG5pbnRlcmZhY2UgQXV0aFZhbGlkYXRpb25SZXNwb25zZSB7XG4gIHZhbGlkOiBib29sZWFuO1xuICB1c2VyOiB7XG4gICAgaWQ6IHN0cmluZztcbiAgICBlbWFpbDogc3RyaW5nO1xuICAgIHJvbGVzOiBzdHJpbmdbXTtcbiAgfTtcbiAgZXhwaXJlc0F0OiBzdHJpbmc7XG59XG5cbi8qKlxuICogSW50ZXJmYWNlIHBvdXIgbGVzIG3DqXRyaXF1ZXMgZCdhdWRpdFxuICovXG5pbnRlcmZhY2UgQXV0aEF1ZGl0TWV0cmljcyB7XG4gIGV2ZW50OiAnYXV0aF9hdHRlbXB0JztcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgdXNlcklkPzogc3RyaW5nO1xuICB0b2tlbkhhc2g6IHN0cmluZztcbiAgdGltZXN0YW1wOiBzdHJpbmc7XG4gIHJlcXVlc3RJZD86IHN0cmluZztcbiAgZXJyb3I/OiBzdHJpbmc7XG4gIGNhY2hlaGl0PzogYm9vbGVhbjtcbiAgdmFsaWRhdGlvbkR1cmF0aW9uPzogbnVtYmVyO1xufVxuXG4vKipcbiAqIENvbmZpZ3VyYXRpb24gcGFyIGTDqWZhdXQgZHUgZ3VhcmRcbiAqL1xuY29uc3QgREVGQVVMVF9DT05GSUcgPSB7XG4gIGNhY2hlUHJlZml4OiAnYXV0aDp0b2tlbjonLFxuICBjYWNoZVRUTDogMzAwLCAvLyA1IG1pbnV0ZXNcbiAgdmFsaWRhdGlvblRpbWVvdXQ6IDUwMDAsIC8vIDUgc2Vjb25kZXNcbiAgcmV0cnlBdHRlbXB0czogMyxcbiAgcmV0cnlEZWxheTogMTAwMCwgLy8gMSBzZWNvbmRlXG4gIGxvZ0xldmVsOiAnaW5mbycsXG59IGFzIGNvbnN0O1xuXG4vKipcbiAqIEd1YXJkIGQnYXV0aGVudGlmaWNhdGlvbiBKV1RcbiAqIFxuICogSW1wbMOpbWVudGUgbGEgdmFsaWRhdGlvbiBzw6ljdXJpc8OpZSBkZXMgdG9rZW5zIEpXVCBhdmVjIGNhY2hlIFJlZGlzXG4gKiBwb3VyIG9wdGltaXNlciBsZXMgcGVyZm9ybWFuY2VzIGV0IGF1ZGl0IGNvbXBsZXQgZGVzIGFjY8Oocy5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEF1dGhHdWFyZCBpbXBsZW1lbnRzIENhbkFjdGl2YXRlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEF1dGhHdWFyZC5uYW1lKTtcbiAgcHJpdmF0ZSByZWFkb25seSBBVVRIX1NFUlZJQ0VfVVJMOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgQ0FDSEVfVFRMOiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgVkFMSURBVElPTl9USU1FT1VUOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBodHRwU2VydmljZTogSHR0cFNlcnZpY2UsXG4gICkge1xuICAgIC8vIFLDqWN1cMOpcmF0aW9uIGRlIGxhIGNvbmZpZ3VyYXRpb24gYXZlYyBmYWxsYmFjayBkaXJlY3Qgc3VyIGxlcyB2YXJpYWJsZXMgZCdlbnZpcm9ubmVtZW50XG4gICAgdGhpcy5BVVRIX1NFUlZJQ0VfVVJMID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdBVVRIX1NFUlZJQ0VfVVJMJykgfHwgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmVudi5BVVRIX1NFUlZJQ0VfVVJMIHx8IFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMSc7XG4gICAgdGhpcy5WQUxJREFUSU9OX1RJTUVPVVQgPSBwYXJzZUludChcbiAgICAgIHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignQVVUSF9TRVJWSUNFX1RJTUVPVVQnKSB8fCBcbiAgICAgIHByb2Nlc3MuZW52LkFVVEhfU0VSVklDRV9USU1FT1VUIHx8IFxuICAgICAgJzUwMDAnLCBcbiAgICAgIDEwXG4gICAgKTtcbiAgICB0aGlzLkNBQ0hFX1RUTCA9IHBhcnNlSW50KFxuICAgICAgdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdDQUNIRV9UVEwnKSB8fCBcbiAgICAgIHByb2Nlc3MuZW52LkNBQ0hFX1RUTCB8fCBcbiAgICAgIERFRkFVTFRfQ09ORklHLmNhY2hlVFRMLnRvU3RyaW5nKCksXG4gICAgICAxMFxuICAgICk7XG5cbiAgICB0aGlzLmxvZ2dlci5sb2coYEF1dGhHdWFyZCBpbml0aWFsaXplZCB3aXRoIHNlcnZpY2UgVVJMOiAke3RoaXMuQVVUSF9TRVJWSUNFX1VSTH1gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQb2ludCBkJ2VudHLDqWUgcHJpbmNpcGFsIGR1IGd1YXJkIE5lc3RKU1xuICAgKiBcbiAgICogQHBhcmFtIGNvbnRleHQgLSBDb250ZXh0ZSBkJ2V4w6ljdXRpb24gZGUgbGEgcmVxdcOqdGVcbiAgICogQHJldHVybnMgUHJvbWlzZTxib29sZWFuPiAtIHRydWUgc2kgYXV0aGVudGlmaWNhdGlvbiByw6l1c3NpZVxuICAgKi9cbiAgYXN5bmMgY2FuQWN0aXZhdGUoY29udGV4dDogRXhlY3V0aW9uQ29udGV4dCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgbGV0IHVzZXI6IFVzZXIgfCB1bmRlZmluZWQ7XG4gICAgbGV0IHRva2VuSGFzaCA9ICcnO1xuICAgIGxldCBjYWNoZUhpdCA9IGZhbHNlO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEV4dHJhY3Rpb24gZGUgbGEgcmVxdcOqdGUgc2Vsb24gbGUgY29udGV4dGUgKEhUVFAsIFdlYlNvY2tldCwgZXRjLilcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLmdldFJlcXVlc3QoY29udGV4dCk7XG4gICAgICBcbiAgICAgIC8vIEV4dHJhY3Rpb24gZHUgdG9rZW4gSldUXG4gICAgICBjb25zdCB0b2tlbiA9IHRoaXMuZXh0cmFjdFRva2VuRnJvbVJlcXVlc3QocmVxdWVzdCk7XG4gICAgICBpZiAoIXRva2VuKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYXVkaXRBY2Nlc3NBdHRlbXB0KCcnLCBmYWxzZSwgdW5kZWZpbmVkLCBuZXcgRXJyb3IoJ1Rva2VuIG1pc3NpbmcnKSwgZmFsc2UsIERhdGUubm93KCkgLSBzdGFydFRpbWUpO1xuICAgICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdBdXRoZW50aWNhdGlvbiB0b2tlbiBpcyByZXF1aXJlZCcpO1xuICAgICAgfVxuXG4gICAgICAvLyBHw6luw6lyYXRpb24gZHUgaGFzaCBwb3VyIGxlIGNhY2hlIGV0IGwnYXVkaXRcbiAgICAgIHRva2VuSGFzaCA9IHRoaXMuaGFzaFRva2VuKHRva2VuKTtcblxuICAgICAgLy8gVsOpcmlmaWNhdGlvbiBkdSBjYWNoZVxuICAgICAgdXNlciA9IGF3YWl0IHRoaXMuZ2V0Q2FjaGVkVmFsaWRhdGlvbih0b2tlbik7XG4gICAgICBpZiAodXNlcikge1xuICAgICAgICBjYWNoZUhpdCA9IHRydWU7XG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBDYWNoZSBoaXQgZm9yIHRva2VuICR7dG9rZW5IYXNoLnN1YnN0cmluZygwLCA4KX0uLi5gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFZhbGlkYXRpb24gdmlhIGxlIHNlcnZpY2UgZCdhdXRoZW50aWZpY2F0aW9uXG4gICAgICAgIHVzZXIgPSBhd2FpdCB0aGlzLnZhbGlkYXRlVG9rZW5XaXRoQXV0aFNlcnZpY2UodG9rZW4pO1xuICAgICAgICBcbiAgICAgICAgLy8gTWlzZSBlbiBjYWNoZSBkZSBsYSB2YWxpZGF0aW9uIHLDqXVzc2llXG4gICAgICAgIGF3YWl0IHRoaXMuY2FjaGVWYWxpZGF0aW9uKHRva2VuLCB1c2VyLCBuZXcgRGF0ZShEYXRlLm5vdygpICsgdGhpcy5DQUNIRV9UVEwgKiAxMDAwKSk7XG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBUb2tlbiB2YWxpZGF0ZWQgYW5kIGNhY2hlZCBmb3IgJHt1c2VyLmVtYWlsfWApO1xuICAgICAgfVxuXG4gICAgICAvLyBJbmplY3Rpb24gZGUgbCd1dGlsaXNhdGV1ciBkYW5zIGxlIGNvbnRleHRlXG4gICAgICB0aGlzLmluamVjdFVzZXJJbnRvQ29udGV4dChjb250ZXh0LCB1c2VyKTtcblxuICAgICAgLy8gQXVkaXQgZGUgbGEgdGVudGF0aXZlIHLDqXVzc2llXG4gICAgICBhd2FpdCB0aGlzLmF1ZGl0QWNjZXNzQXR0ZW1wdCh0b2tlbkhhc2gsIHRydWUsIHVzZXIsIHVuZGVmaW5lZCwgY2FjaGVIaXQsIERhdGUubm93KCkgLSBzdGFydFRpbWUpO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBBdWRpdCBkZSBsYSB0ZW50YXRpdmUgw6ljaG91w6llXG4gICAgICBhd2FpdCB0aGlzLmF1ZGl0QWNjZXNzQXR0ZW1wdCh0b2tlbkhhc2gsIGZhbHNlLCB1c2VyLCBlcnJvciBhcyBFcnJvciwgY2FjaGVIaXQsIERhdGUubm93KCkgLSBzdGFydFRpbWUpO1xuICAgICAgXG4gICAgICAvLyBHZXN0aW9uIGRlcyBlcnJldXJzXG4gICAgICB0aGlzLmhhbmRsZUF1dGhFcnJvcihlcnJvciwgJ2NhbkFjdGl2YXRlJyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3Rpb24gZGUgbCdvYmpldCByZXF1ZXN0IHNlbG9uIGxlIHR5cGUgZGUgY29udGV4dGVcbiAgICogXG4gICAqIEBwYXJhbSBjb250ZXh0IC0gQ29udGV4dGUgZCdleMOpY3V0aW9uXG4gICAqIEByZXR1cm5zIEwnb2JqZXQgcmVxdWVzdFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRSZXF1ZXN0KGNvbnRleHQ6IEV4ZWN1dGlvbkNvbnRleHQpOiBGYXN0aWZ5UmVxdWVzdCB7XG4gICAgY29uc3QgY29udGV4dFR5cGUgPSBjb250ZXh0LmdldFR5cGU8J2h0dHAnIHwgJ3dzJz4oKTtcbiAgICBcbiAgICBzd2l0Y2ggKGNvbnRleHRUeXBlKSB7XG4gICAgICBjYXNlICdodHRwJzpcbiAgICAgICAgcmV0dXJuIGNvbnRleHQuc3dpdGNoVG9IdHRwKCkuZ2V0UmVxdWVzdDxGYXN0aWZ5UmVxdWVzdD4oKTtcbiAgICAgIGNhc2UgJ3dzJzpcbiAgICAgICAgLy8gU3VwcG9ydCBXZWJTb2NrZXQgc2kgbsOpY2Vzc2FpcmUgZGFucyBsZSBmdXR1clxuICAgICAgICByZXR1cm4gY29udGV4dC5zd2l0Y2hUb1dzKCkuZ2V0Q2xpZW50KCkuaGFuZHNoYWtlO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ1Vuc3VwcG9ydGVkIGNvbnRleHQgdHlwZScpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWN0aW9uIGR1IHRva2VuIEpXVCBkZXB1aXMgbGVzIGhlYWRlcnMgZGUgcmVxdcOqdGVcbiAgICogXG4gICAqIEBwYXJhbSByZXF1ZXN0IC0gUmVxdcOqdGUgRmFzdGlmeVxuICAgKiBAcmV0dXJucyBUb2tlbiBKV1Qgb3UgbnVsbCBzaSBhYnNlbnQvaW52YWxpZGVcbiAgICovXG4gIHByaXZhdGUgZXh0cmFjdFRva2VuRnJvbVJlcXVlc3QocmVxdWVzdDogRmFzdGlmeVJlcXVlc3QpOiBzdHJpbmcgfCBudWxsIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYXV0aEhlYWRlciA9IHJlcXVlc3QuaGVhZGVycy5hdXRob3JpemF0aW9uO1xuICAgICAgXG4gICAgICBpZiAoIWF1dGhIZWFkZXIpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIC8vIFbDqXJpZmljYXRpb24gZHUgZm9ybWF0IFwiQmVhcmVyIDx0b2tlbj5cIlxuICAgICAgY29uc3QgcGFydHMgPSBhdXRoSGVhZGVyLnNwbGl0KCcgJyk7XG4gICAgICBpZiAocGFydHMubGVuZ3RoICE9PSAyIHx8IHBhcnRzWzBdICE9PSAnQmVhcmVyJykge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKCdJbnZhbGlkIGF1dGhvcml6YXRpb24gaGVhZGVyIGZvcm1hdCcpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdG9rZW4gPSBwYXJ0c1sxXTtcbiAgICAgIFxuICAgICAgLy8gVmFsaWRhdGlvbiBiYXNpcXVlIGR1IHRva2VuIChub24gdmlkZSwgbG9uZ3VldXIgbWluaW1hbGUpXG4gICAgICBpZiAoIXRva2VuIHx8IHRva2VuLmxlbmd0aCA8IDEwKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oJ1Rva2VuIHRvbyBzaG9ydCBvciBlbXB0eScpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRva2VuO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvciBleHRyYWN0aW5nIHRva2VuIGZyb20gcmVxdWVzdCcsIGVycm9yKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZWNoZXJjaGUgZCd1bmUgdmFsaWRhdGlvbiBlbiBjYWNoZVxuICAgKiBcbiAgICogQHBhcmFtIHRva2VuIC0gVG9rZW4gSldUIMOgIHbDqXJpZmllclxuICAgKiBAcmV0dXJucyBVdGlsaXNhdGV1ciBzaSB0cm91dsOpIGVuIGNhY2hlLCB1bmRlZmluZWQgc2lub25cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0Q2FjaGVkVmFsaWRhdGlvbih0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxVc2VyIHwgdW5kZWZpbmVkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gdGhpcy5idWlsZENhY2hlS2V5KHRva2VuKTtcbiAgICAgIGNvbnN0IGNhY2hlZERhdGEgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQ8VXNlcj4oY2FjaGVLZXkpO1xuICAgICAgXG4gICAgICBpZiAoY2FjaGVkRGF0YSAmJiBpc1ZhbGlkVXNlcihjYWNoZWREYXRhKSkge1xuICAgICAgICByZXR1cm4gY2FjaGVkRGF0YTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKCdDYWNoZSByZXRyaWV2YWwgZmFpbGVkLCBmYWxsaW5nIGJhY2sgdG8gc2VydmljZSB2YWxpZGF0aW9uJywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGlvbiBkdSB0b2tlbiB2aWEgbGUgU2VydmljZSBkJ0F1dGhlbnRpZmljYXRpb24gKEMwMylcbiAgICogXG4gICAqIEBwYXJhbSB0b2tlbiAtIFRva2VuIEpXVCDDoCB2YWxpZGVyXG4gICAqIEByZXR1cm5zIFV0aWxpc2F0ZXVyIHZhbGlkw6lcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgdmFsaWRhdGVUb2tlbldpdGhBdXRoU2VydmljZSh0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxVc2VyPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb25VcmwgPSBgJHt0aGlzLkFVVEhfU0VSVklDRV9VUkx9L2FwaS92MS9hdXRoL3ZhbGlkYXRlLXRva2VuYDtcbiAgICAgIFxuICAgICAgY29uc3QgcmVzcG9uc2UkID0gdGhpcy5odHRwU2VydmljZS5wb3N0PEF1dGhWYWxpZGF0aW9uUmVzcG9uc2U+KFxuICAgICAgICB2YWxpZGF0aW9uVXJsLFxuICAgICAgICB7IHRva2VuIH0sXG4gICAgICAgIHtcbiAgICAgICAgICB0aW1lb3V0OiB0aGlzLlZBTElEQVRJT05fVElNRU9VVCxcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgJ1VzZXItQWdlbnQnOiAncHJvamVjdC1zZXJ2aWNlLzEuMC4wJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICApLnBpcGUoXG4gICAgICAgIHRpbWVvdXQodGhpcy5WQUxJREFUSU9OX1RJTUVPVVQpLFxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogQXhpb3NFcnJvcikgPT4ge1xuICAgICAgICAgIGlmIChlcnJvci5yZXNwb25zZT8uc3RhdHVzID09PSA0MDEpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ0ludmFsaWQgb3IgZXhwaXJlZCB0b2tlbicpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ0VDT05OUkVGVVNFRCcgfHwgZXJyb3IuY29kZSA9PT0gJ0VOT1RGT1VORCcpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBTZXJ2aWNlVW5hdmFpbGFibGVFeGNlcHRpb24oJ0F1dGhlbnRpY2F0aW9uIHNlcnZpY2UgdW5hdmFpbGFibGUnKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ0F1dGhlbnRpY2F0aW9uIHNlcnZpY2UgZXJyb3InKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmlyc3RWYWx1ZUZyb20ocmVzcG9uc2UkKTtcbiAgICAgIGNvbnN0IGRhdGEgPSByZXNwb25zZS5kYXRhO1xuXG4gICAgICAvLyBWYWxpZGF0aW9uIGRlIGxhIHLDqXBvbnNlXG4gICAgICBpZiAoIWRhdGEudmFsaWQgfHwgIWRhdGEudXNlcikge1xuICAgICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdUb2tlbiB2YWxpZGF0aW9uIGZhaWxlZCcpO1xuICAgICAgfVxuXG4gICAgICAvLyBDb25zdHJ1Y3Rpb24gZGUgbCdvYmpldCBVc2VyXG4gICAgICBjb25zdCB1c2VyOiBVc2VyID0ge1xuICAgICAgICBpZDogZGF0YS51c2VyLmlkLFxuICAgICAgICBlbWFpbDogZGF0YS51c2VyLmVtYWlsLFxuICAgICAgICByb2xlczogZGF0YS51c2VyLnJvbGVzIHx8IFtdLFxuICAgICAgfTtcblxuICAgICAgLy8gVmFsaWRhdGlvbiBmaW5hbGUgZGUgbCdvYmpldCBVc2VyXG4gICAgICBpZiAoIWlzVmFsaWRVc2VyKHVzZXIpKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKCdJbnZhbGlkIHVzZXIgZGF0YSByZWNlaXZlZCBmcm9tIGF1dGggc2VydmljZScpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdXNlcjtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVbmF1dGhvcml6ZWRFeGNlcHRpb24gfHwgXG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBTZXJ2aWNlVW5hdmFpbGFibGVFeGNlcHRpb24gfHwgXG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgICAgXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignVW5leHBlY3RlZCBlcnJvciBkdXJpbmcgdG9rZW4gdmFsaWRhdGlvbicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKCdBdXRoZW50aWNhdGlvbiBmYWlsZWQnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTWlzZSBlbiBjYWNoZSBkZSBsYSB2YWxpZGF0aW9uIHLDqXVzc2llXG4gICAqIFxuICAgKiBAcGFyYW0gdG9rZW4gLSBUb2tlbiBKV1RcbiAgICogQHBhcmFtIHVzZXIgLSBVdGlsaXNhdGV1ciB2YWxpZMOpXG4gICAqIEBwYXJhbSBleHBpcmVzQXQgLSBEYXRlIGQnZXhwaXJhdGlvbiBkdSB0b2tlblxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjYWNoZVZhbGlkYXRpb24odG9rZW46IHN0cmluZywgdXNlcjogVXNlciwgZXhwaXJlc0F0OiBEYXRlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gdGhpcy5idWlsZENhY2hlS2V5KHRva2VuKTtcbiAgICAgIFxuICAgICAgLy8gQ2FsY3VsIGR1IFRUTCBpbnRlbGxpZ2VudCBiYXPDqSBzdXIgbCdleHBpcmF0aW9uIGR1IHRva2VuXG4gICAgICBjb25zdCB0aW1lVW50aWxFeHBpcnkgPSBNYXRoLmZsb29yKChleHBpcmVzQXQuZ2V0VGltZSgpIC0gRGF0ZS5ub3coKSkgLyAxMDAwKTtcbiAgICAgIGNvbnN0IHR0bCA9IE1hdGgubWluKHRoaXMuQ0FDSEVfVFRMLCBNYXRoLm1heCh0aW1lVW50aWxFeHBpcnksIDYwKSk7IC8vIE1pbiAxIG1pbnV0ZVxuXG4gICAgICBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoY2FjaGVLZXksIHVzZXIsIHR0bCk7XG4gICAgICBcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gQ2FjaGUgbm9uIGNyaXRpcXVlIC0gb24gbG9nIG1haXMgb24gbmUgYmxvcXVlIHBhc1xuICAgICAgdGhpcy5sb2dnZXIud2FybignRmFpbGVkIHRvIGNhY2hlIHRva2VuIHZhbGlkYXRpb24nLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEluamVjdGlvbiBkZSBsJ3V0aWxpc2F0ZXVyIGRhbnMgbGUgY29udGV4dGUgZGUgcmVxdcOqdGVcbiAgICogXG4gICAqIEBwYXJhbSBjb250ZXh0IC0gQ29udGV4dGUgZCdleMOpY3V0aW9uXG4gICAqIEBwYXJhbSB1c2VyIC0gVXRpbGlzYXRldXIgw6AgaW5qZWN0ZXJcbiAgICovXG4gIHByaXZhdGUgaW5qZWN0VXNlckludG9Db250ZXh0KGNvbnRleHQ6IEV4ZWN1dGlvbkNvbnRleHQsIHVzZXI6IFVzZXIpOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuZ2V0UmVxdWVzdChjb250ZXh0KTtcbiAgICAgIFxuICAgICAgLy8gSW5qZWN0aW9uIHBvdXIgdXRpbGlzYXRpb24gcGFyIGxlIGTDqWNvcmF0ZXVyIEBDdXJyZW50VXNlcigpXG4gICAgICAocmVxdWVzdCBhcyBhbnkpLnVzZXIgPSB1c2VyO1xuICAgICAgXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gaW5qZWN0IHVzZXIgaW50byBjb250ZXh0JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ0NvbnRleHQgaW5qZWN0aW9uIGZhaWxlZCcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBdWRpdCBkZXMgdGVudGF0aXZlcyBkJ2FjY8OocyBwb3VyIGxhIHPDqWN1cml0w6kgZXQgbGUgbW9uaXRvcmluZ1xuICAgKiBcbiAgICogQHBhcmFtIHRva2VuSGFzaCAtIEhhc2ggZHUgdG9rZW4gKHBvdXIgbGEgc8OpY3VyaXTDqSlcbiAgICogQHBhcmFtIHN1Y2Nlc3MgLSBTdWNjw6hzIG91IMOpY2hlYyBkZSBsJ2F1dGhlbnRpZmljYXRpb25cbiAgICogQHBhcmFtIHVzZXIgLSBVdGlsaXNhdGV1ciAoc2kgYXV0aGVudGlmaWNhdGlvbiByw6l1c3NpZSlcbiAgICogQHBhcmFtIGVycm9yIC0gRXJyZXVyIChzaSBhdXRoZW50aWZpY2F0aW9uIMOpY2hvdcOpZSlcbiAgICogQHBhcmFtIGNhY2hlSGl0IC0gSW5kaWNhdGV1ciBkZSBjYWNoZSBoaXRcbiAgICogQHBhcmFtIGR1cmF0aW9uIC0gRHVyw6llIGRlIHZhbGlkYXRpb24gZW4gbXNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgYXVkaXRBY2Nlc3NBdHRlbXB0KFxuICAgIHRva2VuSGFzaDogc3RyaW5nLFxuICAgIHN1Y2Nlc3M6IGJvb2xlYW4sXG4gICAgdXNlcj86IFVzZXIsXG4gICAgZXJyb3I/OiBFcnJvcixcbiAgICBjYWNoZUhpdD86IGJvb2xlYW4sXG4gICAgZHVyYXRpb24/OiBudW1iZXJcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGF1ZGl0RGF0YTogQXV0aEF1ZGl0TWV0cmljcyA9IHtcbiAgICAgICAgZXZlbnQ6ICdhdXRoX2F0dGVtcHQnLFxuICAgICAgICBzdWNjZXNzLFxuICAgICAgICB0b2tlbkhhc2g6IHRva2VuSGFzaC5zdWJzdHJpbmcoMCwgMTYpLCAvLyBQcmVtaWVycyAxNiBjYXJhY3TDqHJlcyBwb3VyIGwnYXVkaXRcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIHVzZXJJZDogdXNlcj8uaWQsXG4gICAgICAgIGVycm9yOiBlcnJvcj8ubWVzc2FnZSxcbiAgICAgICAgY2FjaGVoaXQ6IGNhY2hlSGl0LFxuICAgICAgICB2YWxpZGF0aW9uRHVyYXRpb246IGR1cmF0aW9uLFxuICAgICAgfTtcblxuICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKGDinIUgQXV0aGVudGljYXRpb24gc3VjY2Vzc2Z1bCBmb3IgdXNlciAke3VzZXI/LmVtYWlsfWAsIGF1ZGl0RGF0YSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGDinYwgQXV0aGVudGljYXRpb24gZmFpbGVkOiAke2Vycm9yPy5tZXNzYWdlfWAsIGF1ZGl0RGF0YSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFRPRE86IE9wdGlvbm5lbGxlbWVudCBlbnZveWVyIHZlcnMgdW4gc2VydmljZSBkJ2F1ZGl0IGV4dGVybmVcbiAgICAgIC8vIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoYXVkaXREYXRhKTtcblxuICAgIH0gY2F0Y2ggKGF1ZGl0RXJyb3IpIHtcbiAgICAgIC8vIEwnYXVkaXQgbmUgZG9pdCBqYW1haXMgYmxvcXVlciBsJ2F1dGhlbnRpZmljYXRpb25cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdBdWRpdCBsb2dnaW5nIGZhaWxlZCcsIGF1ZGl0RXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXN0aW9uIGNlbnRyYWxpc8OpZSBkZXMgZXJyZXVycyBkJ2F1dGhlbnRpZmljYXRpb25cbiAgICogXG4gICAqIEBwYXJhbSBlcnJvciAtIEVycmV1ciDDoCB0cmFpdGVyXG4gICAqIEBwYXJhbSBjb250ZXh0IC0gQ29udGV4dGUgb8O5IGwnZXJyZXVyIHMnZXN0IHByb2R1aXRlXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZUF1dGhFcnJvcihlcnJvcjogYW55LCBjb250ZXh0OiBzdHJpbmcpOiBuZXZlciB7XG4gICAgLy8gQ2xhc3NpZmljYXRpb24gZXQgdHJhbnNmb3JtYXRpb24gZGVzIGVycmV1cnNcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVbmF1dGhvcml6ZWRFeGNlcHRpb24gfHwgXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgU2VydmljZVVuYXZhaWxhYmxlRXhjZXB0aW9uIHx8IFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24pIHtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cblxuICAgIC8vIEVycmV1cnMgaW5hdHRlbmR1ZXNcbiAgICB0aGlzLmxvZ2dlci5lcnJvcihgVW5leHBlY3RlZCBhdXRoZW50aWNhdGlvbiBlcnJvciBpbiAke2NvbnRleHR9YCwgZXJyb3IpO1xuICAgIFxuICAgIC8vIE5lIHBhcyBsZWFrIGQnaW5mb3JtYXRpb25zIHNlbnNpYmxlc1xuICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdGlvbiBkZSBsYSBjbMOpIGRlIGNhY2hlIHPDqWN1cmlzw6llXG4gICAqIFxuICAgKiBAcGFyYW0gdG9rZW4gLSBUb2tlbiBKV1RcbiAgICogQHJldHVybnMgQ2zDqSBkZSBjYWNoZSBoYXNow6llXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkQ2FjaGVLZXkodG9rZW46IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgaGFzaCA9IHRoaXMuaGFzaFRva2VuKHRva2VuKTtcbiAgICByZXR1cm4gYCR7REVGQVVMVF9DT05GSUcuY2FjaGVQcmVmaXh9JHtoYXNofWA7XG4gIH1cblxuICAvKipcbiAgICogR8OpbsOpcmF0aW9uIGQndW4gaGFzaCBTSEEtMjU2IGR1IHRva2VuIHBvdXIgbGEgc8OpY3VyaXTDqVxuICAgKiBcbiAgICogQHBhcmFtIHRva2VuIC0gVG9rZW4gw6AgaGFzaGVyXG4gICAqIEByZXR1cm5zIEhhc2ggU0hBLTI1NiBlbiBoZXhhZMOpY2ltYWxcbiAgICovXG4gIHByaXZhdGUgaGFzaFRva2VuKHRva2VuOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBjcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUodG9rZW4pLmRpZ2VzdCgnaGV4Jyk7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=